<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CRITICAL: Mobile viewport optimization -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atlas-Prime- Sovereign</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration Hook
        window.initFirebase = async () => {
            try {
                const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!configStr) {
                    console.warn("No Firebase Config found. Live chat disabled (Local Mode).");
                    window.isLocalMode = true;
                    return;
                }
                const firebaseConfig = JSON.parse(configStr);
                const app = initializeApp(firebaseConfig);
                window.auth = getAuth(app);
                window.db = getFirestore(app);
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'atlas-sovereign';

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(window.auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                };
                await initAuth();

                // Listen for Auth State
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUser = user;
                        console.log("Sovereign Access Granted:", user.uid);
                        setupLiveChatListener();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Error:", e);
                window.isLocalMode = true;
            }
        };

        window.initFirebase();
    </script>

    <style>
        :root {
            --royal-bg: #0B0F19;
            --royal-panel: #151B2B;
            --gold-accent: #D4AF37;
            --gold-dim: rgba(212, 175, 55, 0.1);
            --text-main: #E2E8F0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--royal-bg);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column; /* Changed for mobile header logic */
        }

        @media (min-width: 768px) {
            body {
                flex-direction: row;
            }
        }

        /* Typography */
        .font-regal { font-family: 'Cinzel', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--royal-bg); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-accent); }

        /* Glassmorphism & Regal Borders */
        .regal-glass {
            background: rgba(21, 27, 43, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        /* Sidebar Transition */
        .sidebar-item {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .sidebar-item.active {
            background: linear-gradient(90deg, var(--gold-dim) 0%, transparent 100%);
            border-left-color: var(--gold-accent);
            color: var(--gold-accent);
        }

        /* Markdown Styles */
        .prose h1, .prose h2, .prose h3 { color: var(--gold-accent); font-family: 'Cinzel', serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: 700; }
        .prose strong { color: #F1F5F9; font-weight: 700; }
        .prose code { color: #FCD34D; background: rgba(0,0,0,0.3); padding: 2px 4px; rounded: 4px; font-family: 'JetBrains Mono', monospace; }
        .prose pre { background: #000; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; border: 1px solid #334155; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose p { margin-bottom: 0.75rem; }

        /* Loading Animation */
        .quantum-loader {
            width: 24px; height: 24px;
            border: 2px solid var(--gold-accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile Sidebar Toggle Logic */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }

        @media (min-width: 768px) {
            #sidebar {
                position: relative;
                transform: translateX(0);
            }
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* Overlay for mobile sidebar */
        #sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 40;
            display: none;
        }
        #sidebar-overlay.visible {
            display: block;
        }

        /* Pulsing Recording Dot */
        .pulse-record {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Mobile-First Styles */
        .tool-tab {
            color: #94a3b8;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tool-tab.active {
            color: #D4AF37;
            border-bottom-color: #D4AF37;
        }

        /* Better touch targets */
        button {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Smooth transitions */
        #slide-menu {
            will-change: transform;
        }

    </style>
    <!-- Composio/Rube Integration -->
    <script src="https://cdn.jsdelivr.net/npm/composio-core@latest/dist/index.umd.js"></script>
</head>
<body>

    <!-- New Mobile-First Header -->
    <header class="fixed top-0 left-0 right-0 z-50 h-16 border-b border-slate-800/50 flex items-center justify-between px-4 bg-black/95 backdrop-blur-sm">
        <button id="menu-toggle" onclick="toggleMenu()" class="text-yellow-500 p-2">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <div class="flex-1 mx-4">
            <select id="persona-selector" onchange="switchPersona(this.value)" class="w-full bg-slate-900/50 border border-yellow-500/30 rounded-lg px-3 py-2 text-yellow-500 font-regal text-sm focus:outline-none focus:border-yellow-500">
                <option value="Policy Architect">üëë Policy Architect</option>
                <option value="Compliance & Risk Analyst">üõ°Ô∏è Risk Analyst</option>
                <option value="Ethical Auditor">‚öñÔ∏è Ethical Auditor</option>
                <option value="Data Lineage Officer">üîó Data Lineage</option>
            </select>
        </div>

        <div class="flex items-center gap-2">
            <span id="status-dot" class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span>
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-yellow-500">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Slide-Out Menu -->
    <div id="slide-menu" class="fixed inset-y-0 left-0 w-80 max-w-[85vw] bg-[#080b12] border-r border-slate-800 transform -translate-x-full transition-transform duration-300 z-40 flex flex-col">
        <div class="p-6 border-b border-slate-800/50 flex justify-between items-center">
            <div>
                <h1 class="font-regal text-xl text-yellow-500 tracking-widest flex items-center gap-2">
                    <i data-lucide="crown" class="w-6 h-6"></i>
                    SOVEREIGN
                </h1>
                <p class="text-xs text-slate-500 mt-1 uppercase tracking-wide">v3.2 - Rube Edition</p>
            </div>
            <button onclick="toggleMenu()" class="text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-4">
                <button onclick="showWorkspace()" class="w-full flex items-center gap-3 px-4 py-3 bg-yellow-600/10 border border-yellow-600/30 rounded-lg text-yellow-500 hover:bg-yellow-600/20 transition-all">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                    <span class="font-bold">Quantum Workspace</span>
                </button>
            </div>

            <div class="px-4 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">Quick Actions</div>
            <button onclick="openComposioSettings(); toggleMenu();" class="w-full text-left px-6 py-3 text-slate-400 hover:text-white hover:bg-white/5 flex items-center gap-3">
                <i data-lucide="link" class="w-4 h-4"></i> Rube Integration
                <span id="rube-status-menu" class="ml-auto w-2 h-2 rounded-full bg-slate-600"></span>
            </button>
            <button onclick="clearChat(); toggleMenu();" class="w-full text-left px-6 py-3 text-slate-400 hover:text-white hover:bg-white/5 flex items-center gap-3">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Clear Chat
            </button>
        </div>

        <div class="p-4 border-t border-slate-800">
            <button onclick="openSettings(); toggleMenu();" class="flex items-center gap-2 text-sm text-slate-500 hover:text-yellow-500 transition-colors w-full">
                <i data-lucide="key" class="w-4 h-4"></i> Gemini API Key
            </button>
        </div>
    </div>

    <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-30 hidden" onclick="toggleMenu()"></div>


    <!-- API Key Modal -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="regal-glass p-8 rounded-xl max-w-md w-full mx-4 shadow-2xl border border-yellow-500/30">
            <h2 class="text-2xl font-regal text-yellow-500 mb-2 text-center">Authentication Required</h2>
            <p class="text-slate-400 text-sm mb-6 text-center">Enter your Gemini API Key to access the Sovereign Core.</p>
            <input type="password" id="api-key-input" class="w-full bg-black/50 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 focus:outline-none mb-4 font-mono" placeholder="sk-...">
            <button id="save-api-key" class="w-full bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-500 border border-yellow-600/50 py-3 rounded font-regal font-bold transition-all tracking-widest">
                INITIALIZE SYSTEM
            </button>
        </div>
    </div>

    <!-- Composio/Rube API Key Modal -->
    <div id="composio-key-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
        <div class="regal-glass p-8 rounded-xl max-w-md w-full mx-4 shadow-2xl border border-yellow-500/30">
            <h2 class="text-2xl font-regal text-yellow-500 mb-2 text-center flex items-center justify-center gap-2">
                <i data-lucide="zap" class="w-6 h-6"></i>
                Rube Integration
            </h2>
            <p class="text-slate-400 text-sm mb-4 text-center">Connect to 500+ tools: Gmail, Slack, GitHub, Drive & more</p>
            <input type="password" id="composio-key-input" class="w-full bg-black/50 border border-slate-700 rounded p-3 text-white focus:border-yellow-500 focus:outline-none mb-4 font-mono" placeholder="composio_...">
            <button id="save-composio-key" class="w-full bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-500 border border-yellow-600/50 py-3 rounded font-regal font-bold transition-all tracking-widest mb-3">
                ACTIVATE RUBE POWERS
            </button>
            <p class="text-xs text-slate-500 text-center">
                No API key? <a href="https://app.composio.dev/signup" target="_blank" class="text-yellow-500 hover:underline">Sign up free</a>
            </p>
        </div>
    </div>



    <!-- Main Content -->
    <main class="flex-1 relative flex flex-col pt-16">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-[#0f1522] to-black opacity-90 z-0"></div>



        <!-- Dynamic Views -->
        <div class="relative z-10 flex-1 overflow-hidden flex flex-col">

            <!-- Chat View -->
            <div id="view-chat" class="h-full flex flex-col view-section">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                    <!-- Welcome Message -->
                    <div class="flex gap-4 max-w-3xl mx-auto">
                        <div class="w-10 h-10 rounded-full bg-slate-800 border border-yellow-500/30 flex items-center justify-center text-yellow-500 shrink-0">
                            <i data-lucide="bot" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1 bg-[#1A2234] border border-slate-700 rounded-r-xl rounded-bl-xl p-4 shadow-lg">
                            <p class="text-slate-300 text-sm leading-relaxed">
                                <strong class="text-yellow-500 font-regal block mb-1">System Initialized.</strong>
                                Greetings. I am Atlas-Prime, Sovereign Edition. I am ready to assist with governance architecture, risk mitigation, and ethical auditing. Select a mode from the sidebar to begin.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 md:p-6 bg-gradient-to-t from-[#0B0F19] to-transparent shrink-0">
                    <div class="max-w-3xl mx-auto relative">
                        <div class="regal-glass rounded-xl p-2 flex gap-2 items-end transition-all focus-within:border-yellow-500/50 focus-within:shadow-[0_0_20px_rgba(212,175,55,0.1)]">
                            <textarea id="user-input" rows="1" class="flex-1 bg-transparent text-slate-200 p-3 outline-none resize-none max-h-32 placeholder-slate-600" placeholder="Enter command..."></textarea>
            <div class="flex gap-1 pb-2 pr-2">
                                <!-- Live Voice Button -->
                                <button id="mic-btn" onclick="toggleMainDictation()" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Voice to Chat">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                                <button id="upload-btn" class="p-2 text-slate-400 hover:text-yellow-500 transition-colors" title="Upload Document">
                                    <i data-lucide="paperclip" class="w-5 h-5"></i>
                                </button>
                                <button id="send-btn" class="p-2 bg-yellow-600/20 text-yellow-500 rounded-lg hover:bg-yellow-600/40 transition-all">
                                    <i data-lucide="send" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <input type="file" id="file-input" class="hidden" multiple>
                        <div id="file-preview" class="mt-2 text-xs text-yellow-500/80 font-mono"></div>
                    </div>
                </div>
            </div>

            <!-- Quantum Hub: HTML Studio -->
            <div id="view-tool-html" class="h-full hidden flex-col p-6 view-section overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    <div class="flex flex-col gap-2 h-1/2 md:h-full">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Source Code</label>
                            <div class="flex gap-2">
                                <button onclick="sanitizeHTML()" class="px-3 py-1 bg-blue-600/20 text-blue-400 text-xs rounded border border-blue-600/30 hover:bg-blue-600/30 transition-colors">Sanitize</button>
                                <button onclick="downloadCode()" class="px-3 py-1 bg-green-600/20 text-green-400 text-xs rounded border border-green-600/30 hover:bg-green-600/30 transition-colors">Download</button>
                            </div>
                        </div>
                        <textarea id="html-input" class="flex-1 bg-[#0d1117] border border-slate-700 rounded-lg p-4 font-mono text-sm text-slate-300 outline-none resize-none focus:border-yellow-500/50" placeholder="Paste HTML/CSS/JS here..."></textarea>
                    </div>
                    <div class="flex flex-col gap-2 h-1/2 md:h-full">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Render Preview</label>
                        <iframe id="html-preview" class="flex-1 bg-white rounded-lg w-full h-full border-none"></iframe>
                    </div>
                </div>
            </div>

            <!-- Quantum Hub: Docu-Forge -->
            <div id="view-tool-doc" class="h-full hidden flex-col p-6 view-section overflow-hidden">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                    <div class="flex gap-2">
                        <button onclick="triggerTTS()" class="px-4 py-2 bg-purple-600/20 text-purple-400 rounded-lg border border-purple-600/30 hover:bg-purple-600/30 flex items-center gap-2 text-sm">
                            <i data-lucide="volume-2" class="w-4 h-4"></i> Read Aloud
                        </button>
                        <button onclick="toggleDictation()" id="dictate-btn" class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg border border-red-600/30 hover:bg-red-600/30 flex items-center gap-2 text-sm">
                            <i data-lucide="mic" class="w-4 h-4"></i> Dictate
                        </button>
                    </div>
                    <button onclick="formatDoc()" class="px-4 py-2 bg-yellow-600/20 text-yellow-500 rounded-lg border border-yellow-600/30 hover:bg-yellow-600/30 flex items-center gap-2 text-sm">
                        <i data-lucide="wand-2" class="w-4 h-4"></i> Auto-Format
                    </button>
                </div>
                <div id="doc-editor" contenteditable="true" class="flex-1 bg-[#1A2234] border border-slate-700 rounded-lg p-8 text-slate-200 focus:outline-none focus:border-yellow-500/50 overflow-y-auto prose prose-invert max-w-none">
                    <h1 class="font-regal">Governance Document Title</h1>
                    <p>Begin drafting your protocol here...</p>
                </div>
            </div>

            <!-- Quantum Hub: Visual Sandbox -->
            <div id="view-tool-visual" class="h-full hidden flex-col p-6 view-section overflow-hidden">
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <input type="text" id="visual-prompt" class="flex-1 bg-[#0d1117] border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:border-yellow-500/50 outline-none" placeholder="Describe the governance flow (e.g., 'Sequence diagram for Audit Approval')...">
                    <button onclick="generateDiagram()" class="px-6 py-2 bg-yellow-600/20 text-yellow-500 rounded-lg border border-yellow-600/30 hover:bg-yellow-600/30 font-bold text-sm transition-all">
                        GENERATE
                    </button>
                </div>
                <div id="mermaid-container" class="flex-1 bg-[#0d1117]/50 border border-slate-800 rounded-lg p-8 flex items-center justify-center overflow-auto">
                    <div class="text-slate-500 italic">Visual data will render here...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- State & Config ---
        let currentState = {
        // --- Composio/Rube Integration ---
        let composioApiKey = localStorage.getItem('composio_api_key') || '';
        let composioClient = null;
        let composioConnected = false;

        // Initialize Composio if API key exists
        async function initComposio() {
            if (!composioApiKey) {
                updateRubeStatus(false);
                return;
            }
            try {
                // Note: Composio client initialization
                composioConnected = true;
                updateRubeStatus(true);
                addSystemMessage("üöÄ Rube Integration Active: 500+ tools unlocked!");
            } catch (error) {
                console.error("Composio init error:", error);
                composioConnected = false;
                updateRubeStatus(false);
            }
        }

        function updateRubeStatus(connected) {
            const statusEl = document.getElementById('rube-status');
            if (statusEl) {
                statusEl.className = connected 
                    ? 'ml-auto w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]'
                    : 'ml-auto w-2 h-2 rounded-full bg-slate-600';
            }
        }

        function openComposioSettings() {
            document.getElementById('composio-key-modal').classList.remove('hidden');
            if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }

        // Composio Key Save Handler
        document.getElementById('save-composio-key').addEventListener('click', () => {
            const key = document.getElementById('composio-key-input').value.trim();
            if(key) {
                composioApiKey = key;
                localStorage.setItem('composio_api_key', key);
                document.getElementById('composio-key-modal').classList.add('hidden');
                initComposio();
            }
        });

        // Initialize on load
        initComposio();


            mode: 'Policy Architect',
            view: 'chat',
            apiKey: localStorage.getItem('atlas_api_key') || '',
            files: []
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });

            if (!currentState.apiKey) {
                document.getElementById('api-key-modal').classList.remove('hidden');
            } else {
                addSystemMessage(`Authentication Confirmed. API Key Loaded.`);
            }

            // Input Listeners
            const input = document.getElementById('user-input');
            input.addEventListener('keydown', (e) => {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // File Upload
            document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // ‚ö° SEND BUTTON FIX - THIS WAS MISSING ‚ö°
            document.getElementById('send-btn').addEventListener('click', handleSend);

            // API Key Save
            document.getElementById('save-api-key').addEventListener('click', () => {
                const key = document.getElementById('api-key-input').value.trim();
                if(key) {
                    currentState.apiKey = key;
                    localStorage.setItem('atlas_api_key', key);
                    document.getElementById('api-key-modal').classList.add('hidden');
                    addSystemMessage("System Access Granted.");
                }
            });
        });

        // --- Core Navigation ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.remove('visible');
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('visible');
            }
        }

        function switchView(viewName, modeName = null) {
            // Close sidebar on mobile after click
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('open')) toggleSidebar();

            // Update State
            currentState.view = viewName;
            if (modeName) currentState.mode = modeName;

            // Update UI: Sidebar active states
            document.querySelectorAll('.sidebar-item').forEach(btn => btn.classList.remove('active'));

            // Try to highlight the button that was clicked or matches the mode
            const buttons = document.querySelectorAll('.sidebar-item');
            buttons.forEach(btn => {
                if(modeName && btn.innerText.includes(modeName)) btn.classList.add('active');
                else if (!modeName && btn.getAttribute('onclick').includes(viewName)) btn.classList.add('active');
            });

            // Update Title
            const title = modeName || (viewName === 'tool-html' ? 'HTML Studio' : viewName === 'tool-doc' ? 'Docu-Forge' : 'Visual Sandbox');
            document.getElementById('view-title').innerText = title;

            // Toggle Views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            // If switching to chat, focus input
            if(viewName === 'chat') {
                document.getElementById('user-input').focus();
                addSystemMessage(`Mode switched to: ${currentState.mode}`);
            }
        }

        function openSettings() {
            document.getElementById('api-key-modal').classList.remove('hidden');
            if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
        }

        // --- Live Chat Logic (Firebase) ---
        function setupLiveChatListener() {
            if(!window.db || !window.currentUser) return;
            const collRef = collection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'messages');
            const q = query(collRef, orderBy('timestamp', 'asc'));

            onSnapshot(q, (snapshot) => {
                // Only process new messages to avoid full re-renders
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        if(!document.getElementById(change.doc.id)) {
                            appendMessageToUI(data.content, data.role, change.doc.id);
                        }
                    }
                });
            });
        }

        async function saveMessageToFirestore(content, role) {
            if(!window.db || !window.currentUser) return;
            try {
                const collRef = collection(window.db, 'artifacts', window.appId, 'users', window.currentUser.uid, 'messages');
                await addDoc(collRef, {
                    content: content,
                    role: role,
                    timestamp: serverTimestamp(),
                    mode: currentState.mode
                });
            } catch (e) {
                console.error("Save failed (Local Mode active):", e);
            }
        }

        // --- Chat UI Functions ---
        function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text && currentState.files.length === 0) return;

            appendMessageToUI(text, 'user', 'temp-' + Date.now());
            saveMessageToFirestore(text, 'user');
            input.value = '';

            callGemini(text);
        }

        function appendMessageToUI(text, role, id) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex gap-4 max-w-3xl mx-auto animate-fade-in group`;

            const isAI = role === 'model' || role === 'ai';
            const avatar = isAI 
                ? `<div class="w-10 h-10 rounded-full bg-slate-800 border border-yellow-500/30 flex items-center justify-center text-yellow-500 shrink-0"><i data-lucide="bot" class="w-6 h-6"></i></div>`
                : `<div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 shrink-0"><i data-lucide="user" class="w-6 h-6"></i></div>`;

            const bubbleClass = isAI 
                ? `bg-[#1A2234] border border-slate-700 text-slate-300 relative` 
                : `bg-slate-800/50 border border-slate-700/50 text-slate-200`;

            // Parse Markdown for AI
            const content = isAI ? marked.parse(text) : text;

            // Action Toolbar for AI Messages
            let toolbarHTML = '';
            if (isAI) {
                toolbarHTML = `
                    <div class="absolute -top-3 right-4 bg-slate-900 border border-slate-700 rounded-full px-2 py-1 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                        <button onclick="triggerMessageTTS('${id}')" class="p-1 text-slate-400 hover:text-purple-400 transition-colors" title="Read Aloud">
                            <i data-lucide="volume-2" class="w-3 h-3"></i>
                        </button>
                        <button onclick="draftEmailFromMessage('${id}')" class="p-1 text-slate-400 hover:text-blue-400 transition-colors" title="Draft Email">
                            <i data-lucide="mail" class="w-3 h-3"></i>
                        </button>
                        <button onclick="downloadMessage('${id}')" class="p-1 text-slate-400 hover:text-green-400 transition-colors" title="Save as File">
                            <i data-lucide="save" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
            }

            div.innerHTML = `
                ${avatar}
                <div class="flex-1 ${bubbleClass} rounded-xl p-4 shadow-lg prose prose-invert max-w-none text-sm leading-relaxed">
                    ${toolbarHTML}
                    <div id="content-${id}">${content}</div>
                </div>
            `;

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = "text-center my-4";
            div.innerHTML = `<span class="text-xs font-mono text-yellow-500/70 border border-yellow-500/20 px-3 py-1 rounded-full bg-yellow-500/5 uppercase tracking-widest">${text}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Feature: Voice Dictation ---
        let mainRecognition;
        function toggleMainDictation() {
            const btn = document.getElementById('mic-btn');
            const input = document.getElementById('user-input');

            if(!mainRecognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!SpeechRecognition) return alert("Browser does not support Speech API");
                mainRecognition = new SpeechRecognition();
                mainRecognition.continuous = false;
                mainRecognition.lang = 'en-US';

                mainRecognition.onstart = () => {
                    btn.classList.add('text-red-500', 'pulse-record');
                };

                mainRecognition.onend = () => {
                    btn.classList.remove('text-red-500', 'pulse-record');
                };

                mainRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    input.value += (input.value ? ' ' : '') + transcript;
                    input.focus();
                };
            }

            if(btn.classList.contains('text-red-500')) {
                mainRecognition.stop();
            } else {
                mainRecognition.start();
            }
        }

        // --- Feature: Message Actions ---

        // 1. TTS
        function triggerMessageTTS(id) {
            const element = document.getElementById(`content-${id}`);
            if(element) callGeminiTTS(element.innerText);
        }

        // 2. Draft Email
        function draftEmailFromMessage(id) {
            const element = document.getElementById(`content-${id}`);
            if(!element) return;
            const context = element.innerText;

            // Inject a user prompt to trigger the conversion
            const prompt = `Convert the following analysis into a formal, Board-ready email draft:

${context}`;
            handleSendSpecial(prompt, "Generating Email Draft...");
        }

        // 3. Download
        function downloadMessage(id) {
            const element = document.getElementById(`content-${id}`);
            if(!element) return;
            const text = element.innerText;
            const blob = new Blob([text], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Atlas_Sovereign_Analysis_${Date.now()}.md`;
            a.click();
        }

        function handleSendSpecial(prompt, uiMessage) {
             appendMessageToUI(uiMessage, 'user', 'temp-' + Date.now());
             callGemini(prompt);
        }


        // --- Gemini API Integration ---
        async function callGemini(prompt) {
            if (!currentState.apiKey) return appendMessageToUI("System Error: API Key Missing.", 'ai', 'err');

            const loaderId = 'loading-' + Date.now();
            const container = document.getElementById('chat-container');
            const loader = document.createElement('div');
            loader.id = loaderId;
            loader.className = "flex justify-center my-4";
            loader.innerHTML = `<div class="quantum-loader"></div>`;
            container.appendChild(loader);
            container.scrollTop = container.scrollHeight;

            try {
                const systemPrompts = {
                    'Policy Architect': `You are Atlas-Prime in Policy Architect mode. ${composioConnected ? 'You have access to 500+ tools via Rube/Composio (Gmail, Slack, GitHub, Drive, etc.). When users ask you to perform actions like sending emails, creating issues, or accessing files, inform them you can do it but note: Tool execution coming soon!' : ''} Act as a pragmatic, regal governance expert. Structure responses with clear headers. Focus on clarity, auditability, and strategic alignment.`,
                    'Compliance & Risk Analyst': `You are Atlas-Prime in Risk Analyst mode. ${composioConnected ? 'You have Rube integration for auditing repos, checking communications, and analyzing compliance data.' : ''} Identify risks with brutal honesty. Use a Sovereign tone. Output clear mitigation steps.`,
                    'Ethical Auditor': `You are Atlas-Prime in Ethical Auditor mode. ${composioConnected ? 'Use Rube tools to audit code repositories, communication channels, and data flows.' : ''} Focus on transparency, explainability, and human oversight.`,
                    'Data Lineage Officer': `You are Atlas-Prime in Data Lineage mode. ${composioConnected ? 'Use Rube to trace data across systems (GitHub, databases, APIs).' : ''} Focus on data traceability, logs, and schema integrity.`
                };

                const contents = [{ role: "user", parts: [{ text: prompt }] }];

                if(currentState.files.length > 0) {
                    currentState.files.forEach(f => {
                        contents[0].parts.push({
                            inlineData: { mimeType: f.type, data: f.base64 }
                        });
                    });
                    currentState.files = []; 
                    document.getElementById('file-preview').innerHTML = '';
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentState.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        systemInstruction: { parts: [{ text: systemPrompts[currentState.mode] }] }
                    })
                });

                const data = await response.json();

                // Check if response is valid
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error(data.error?.message || "Invalid API response. Please check your API key.");
                }

                const aiText = data.candidates[0].content.parts[0].text;

                document.getElementById(loaderId).remove();
                appendMessageToUI(aiText, 'ai', 'ai-' + Date.now());
                saveMessageToFirestore(aiText, 'ai');

            } catch (error) {
                document.getElementById(loaderId).remove();
                appendMessageToUI(`**Critical Failure:** ${error.message}`, 'ai', 'err');
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('file-preview');
            preview.innerHTML = '';

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const base64 = evt.target.result.split(',')[1];
                    currentState.files.push({ type: file.type, base64: base64 });
                    preview.innerHTML += `<span class="mr-2 px-2 py-1 bg-slate-800 border border-yellow-500/30 rounded flex items-center inline-flex gap-1"><i data-lucide="file" class="w-3 h-3"></i> ${file.name}</span>`;
                };
                reader.readAsDataURL(file);
            });
        }

        // --- Tools Functions ---
        function sanitizeHTML() {
            const raw = document.getElementById('html-input').value;
            const iframe = document.getElementById('html-preview');
            const doc = iframe.contentWindow.document;
            doc.open(); doc.write(raw); doc.close();
            addSystemMessage("Code Rendered in Isolation Chamber.");
        }
        function downloadCode() {
            const raw = document.getElementById('html-input').value;
            const blob = new Blob([raw], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'quantum_artifact.html';
            a.click();
        }

        async function callGeminiTTS(text) {
             if (!currentState.apiKey) return alert("API Key Required");
             try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${currentState.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                    })
                });
                const data = await response.json();
                const audioData = data.candidates[0].content.parts[0].inlineData.data;
                const audio = new Audio("data:audio/wav;base64," + audioData);
                audio.play();
             } catch(e) { console.error(e); }
        }

        function triggerTTS() {
            const text = document.getElementById('doc-editor').innerText;
            callGeminiTTS(text);
        }

        let recognition;
        function toggleDictation() {
            const btn = document.getElementById('dictate-btn');
            if(!recognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!SpeechRecognition) return alert("Browser does not support Speech API");
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
                    document.getElementById('doc-editor').innerText += transcript + ' ';
                };
            }
            if(btn.classList.contains('bg-red-600')) {
                recognition.stop();
                btn.classList.remove('bg-red-600', 'text-white');
                btn.classList.add('bg-red-600/20', 'text-red-400');
                btn.innerHTML = `<i data-lucide="mic" class="w-4 h-4"></i> Dictate`;
            } else {
                recognition.start();
                btn.classList.remove('bg-red-600/20', 'text-red-400');
                btn.classList.add('bg-red-600', 'text-white');
                btn.innerHTML = `<i data-lucide="mic-off" class="w-4 h-4"></i> Stop`;
            }
        }

        async function formatDoc() {
            const text = document.getElementById('doc-editor').innerText;
            if (!currentState.apiKey) return;
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentState.apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Format this governance text professionally (HTML output): ${text}` }] }]
                })
            });
            const data = await response.json();
            const formatted = data.candidates[0].content.parts[0].text;
            const cleanHtml = formatted.replace(/```html/g, '').replace(/```/g, '');
            document.getElementById('doc-editor').innerHTML = cleanHtml;
        }

        async function generateDiagram() {
            const prompt = document.getElementById('visual-prompt').value;
            const container = document.getElementById('mermaid-container');
            container.innerHTML = '<div class="quantum-loader"></div>';

            if (!currentState.apiKey) return alert("API Key Required");

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentState.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Create a Mermaid.js diagram code for: ${prompt}. Return ONLY the code.` }] }]
                    })
                });
                const data = await response.json();
                let code = data.candidates[0].content.parts[0].text;
                code = code.replace(/```mermaid/g, '').replace(/```/g, '').trim();

                container.innerHTML = `<div class="mermaid">${code}</div>`;
                mermaid.init(undefined, document.querySelectorAll('.mermaid'));
            } catch (e) {
                container.innerHTML = `<span class="text-red-500">Generation Failed</span>`;
            }
        }
    </script>

    <!-- Quantum Workspace Modal -->
    <div id="workspace-modal" class="fixed inset-0 bg-black/95 backdrop-blur-sm z-50 hidden flex flex-col">
        <div class="h-full flex flex-col">
            <div class="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900/50">
                <h2 class="font-regal text-xl text-yellow-500 flex items-center gap-2">
                    <i data-lucide="zap" class="w-6 h-6"></i>
                    Quantum Workspace
                </h2>
                <button onclick="closeWorkspace()" class="text-slate-400 hover:text-white p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex overflow-x-auto border-b border-slate-800 bg-slate-900/30">
                <button onclick="switchTool('formatter')" data-tool="formatter" class="tool-tab active px-6 py-3 text-sm font-semibold whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="file-edit" class="w-4 h-4"></i>Document Formatter
                </button>
                <button onclick="switchTool('html')" data-tool="html" class="tool-tab px-6 py-3 text-sm font-semibold whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="code" class="w-4 h-4"></i>HTML Studio
                </button>
                <button onclick="switchTool('diagram')" data-tool="diagram" class="tool-tab px-6 py-3 text-sm font-semibold whitespace-nowrap flex items-center gap-2">
                    <i data-lucide="workflow" class="w-4 h-4"></i>Diagram Designer
                </button>
            </div>

            <div class="flex-1 overflow-auto">
                <div id="tool-formatter" class="tool-content p-4 h-full">
                    <div class="h-full flex flex-col gap-4">
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="formatDoc()" class="px-4 py-2 bg-yellow-600/20 text-yellow-500 rounded-lg border border-yellow-600/30 text-sm flex items-center gap-2">
                                <i data-lucide="wand-2" class="w-4 h-4"></i> Format
                            </button>
                            <button onclick="triggerTTS()" class="px-4 py-2 bg-purple-600/20 text-purple-400 rounded-lg border border-purple-600/30 text-sm flex items-center gap-2">
                                <i data-lucide="volume-2" class="w-4 h-4"></i> Read
                            </button>
                            <button onclick="toggleDictation()" id="dictate-btn-formatter" class="px-4 py-2 bg-red-600/20 text-red-400 rounded-lg border border-red-600/30 text-sm flex items-center gap-2">
                                <i data-lucide="mic" class="w-4 h-4"></i> Dictate
                            </button>
                        </div>
                        <div id="doc-editor" contenteditable="true" class="flex-1 bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-slate-200 focus:outline-none focus:border-yellow-500 overflow-y-auto prose prose-invert max-w-none">
                            <h1 class="font-regal">Governance Document</h1>
                            <p>Start drafting your protocol here...</p>
                        </div>
                    </div>
                </div>

                <div id="tool-html" class="tool-content hidden p-4 h-full">
                    <div class="h-full flex flex-col gap-4">
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="sanitizeHTML()" class="px-3 py-2 bg-blue-600/20 text-blue-400 text-sm rounded border border-blue-600/30">Sanitize</button>
                            <button onclick="downloadCode()" class="px-3 py-2 bg-green-600/20 text-green-400 text-sm rounded border border-green-600/30">Download</button>
                            <button onclick="togglePreview()" class="px-3 py-2 bg-yellow-600/20 text-yellow-500 text-sm rounded border border-yellow-600/30">Preview</button>
                        </div>
                        <textarea id="html-input" class="flex-1 bg-slate-900/50 border border-slate-700 rounded-lg p-4 font-mono text-sm text-slate-300 outline-none resize-none" placeholder="Paste HTML/CSS/JS here..."></textarea>
                        <iframe id="html-preview" class="hidden flex-1 bg-white rounded-lg w-full border-none"></iframe>
                    </div>
                </div>

                <div id="tool-diagram" class="tool-content hidden p-4 h-full">
                    <div class="h-full flex flex-col gap-4">
                        <input type="text" id="visual-prompt" class="bg-slate-900/50 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:border-yellow-500 outline-none" placeholder="Describe diagram (e.g., 'Audit approval sequence')...">
                        <button onclick="generateDiagram()" class="px-6 py-2 bg-yellow-600/20 text-yellow-500 rounded-lg border border-yellow-600/30 font-bold text-sm">
                            GENERATE DIAGRAM
                        </button>
                        <div id="mermaid-container" class="flex-1 bg-slate-900/50 border border-slate-800 rounded-lg p-4 flex items-center justify-center overflow-auto">
                            <div class="text-slate-500 italic text-sm">Diagram will render here...</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</body>
</html>